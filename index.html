<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control Bar / Discoteca · PWA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f5f8fb}
    .tile{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem}
    .btn-soft{background:#0d6efd14;border:1px solid #0d6efd22}
    .kpi{min-width:210px}
    .sticky-footer{position:fixed;bottom:6px;left:0;right:0;text-align:center;color:#64748b;font-size:.85rem}
    .cursor{cursor:pointer}
    .hidden{display:none !important}
    .table-sm td,.table-sm th{padding:.4rem .5rem}
    .badge-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:.5rem}
  </style>
</head>

<body>
<div class="container py-4">

  <!-- Header: Fecha activa y acciones -->
  <div class="tile mb-3">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div class="me-3">
        <div class="text-secondary small">Fecha activa</div>
        <input id="fechaActiva" type="date" class="form-control" style="min-width:190px">
        <div class="small text-muted mt-1">Todo lo que agregues se guardará con esta fecha. Puedes cambiarla para editar días pasados.</div>
      </div>

      <div class="ms-auto d-flex gap-2">
        <button id="btnExportXLSX" class="btn btn-outline-primary btn-sm">Excel</button>
        <button id="btnExportPDF" class="btn btn-outline-danger btn-sm">PDF</button>
        <button id="btnReset" class="btn btn-outline-secondary btn-sm">Reset</button>
      </div>
    </div>
  </div>

  <!-- Navegación -->
  <div class="d-flex gap-2 flex-wrap mb-3">
    <button class="btn btn-soft" data-goto="home">Inicio</button>
    <button class="btn btn-soft" data-goto="ventas">Mesero (Ventas Rápidas)</button>
    <button class="btn btn-soft" data-goto="barra">Barra / Granizados (Compras · Inventario · Gastos · Nómina)</button>
    <button class="btn btn-soft" data-goto="socios">Socios (KPIs · Cierres · Distribución)</button>
    <button class="btn btn-soft" data-goto="historial">Historial</button>
    <button class="btn btn-soft" data-goto="cierres">Cierres</button>
  </div>

  <!-- ====================== HOME ====================== -->
  <section id="view_home" class="tile">
    <h6 class="mb-3">KPIs rápida (día)</h6>
    <div class="d-flex flex-wrap gap-3">
      <div class="tile kpi">
        <div class="text-secondary small">Ventas</div>
        <div class="fs-5 fw-semibold" id="kpiVentas">$ 0</div>
      </div>
      <div class="tile kpi">
        <div class="text-secondary small">Efectivo</div>
        <div class="fs-5 fw-semibold" id="kpiEfectivo">$ 0</div>
      </div>
      <div class="tile kpi">
        <div class="text-secondary small">Transf.</div>
        <div class="fs-5 fw-semibold" id="kpiTransf">$ 0</div>
      </div>
      <div class="tile kpi">
        <div class="text-secondary small">Gastos</div>
        <div class="fs-5 fw-semibold" id="kpiGastos">$ 0</div>
      </div>
      <div class="tile kpi">
        <div class="text-secondary small">Compras</div>
        <div class="fs-5 fw-semibold" id="kpiCompras">$ 0</div>
      </div>
      <div class="tile kpi">
        <div class="text-secondary small">Nómina</div>
        <div class="fs-5 fw-semibold" id="kpiNomina">$ 0</div>
      </div>
      <div class="tile kpi bg-success-subtle">
        <div class="text-secondary small">Utilidad hoy (aprox)</div>
        <div class="fs-5 fw-semibold" id="kpiUtilidad">$ 0</div>
      </div>
    </div>

    <hr class="my-4">

    <div>
      <h6 class="mb-3">Resumen de deudas</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="tile">
            <div class="fw-medium mb-2">Empleados (descuadres)</div>
            <ul id="listaDeudasEmpleados" class="list-group list-group-flush small"></ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="tile">
            <div class="fw-medium mb-2">Socios (descuentos / cargos)</div>
            <ul id="listaDeudasSocios" class="list-group list-group-flush small"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== VENTAS ====================== -->
  <section id="view_ventas" class="tile hidden">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Ventas rápidas (Mesero)</h6>
      <button class="btn btn-outline-secondary btn-sm" data-goto="home">Volver</button>
    </div>

    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">POS</label>
        <select id="v_pos" class="form-select">
          <option>Barra</option>
          <option>Granizados</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">Producto</label>
        <div class="input-group">
          <select id="v_sku" class="form-select"></select>
          <button id="btnCargarCatalogo" class="btn btn-outline-primary">Cargar catálogo POS</button>
        </div>
        <div class="form-text">Puedes editar el catálogo en “Barra / Granizados”.</div>
      </div>
      <div class="col-md-2">
        <label class="form-label">Cant.</label>
        <input id="v_cant" type="number" min="1" value="1" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Precio unit.</label>
        <input id="v_pu" type="number" min="0" step="100" value="0" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Pago</label>
        <select id="v_pago" class="form-select">
          <option value="Efectivo">Efectivo</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Mixto">Efectivo + Transferencia</option>
        </select>
      </div>
      <div class="col-md-2 v_mixto hidden">
        <label class="form-label">$ Efectivo</label>
        <input id="v_efectivo" type="number" min="0" step="100" value="0" class="form-control">
      </div>
      <div class="col-md-2 v_mixto hidden">
        <label class="form-label">$ Transf.</label>
        <input id="v_transf" type="number" min="0" step="100" value="0" class="form-control">
      </div>
      <div class="col-md-5">
        <label class="form-label">Notas</label>
        <input id="v_notas" type="text" class="form-control" placeholder="Ej: Mesa 4 / promo">
      </div>
      <div class="col-12">
        <button id="btnAddVenta" class="btn btn-success w-100">Agregar venta</button>
      </div>
    </div>

    <div class="table-responsive mt-4">
      <table class="table table-sm align-middle">
        <thead><tr>
          <th>Fecha</th><th>Hora</th><th>POS</th><th>SKU</th><th>Prod</th><th>Cant</th>
          <th>Pago</th><th>Total</th><th>Notas</th><th></th>
        </tr></thead>
        <tbody id="tblVentas"></tbody>
      </table>
    </div>
  </section>

  <!-- ====================== BARRA / GRANIZADOS ====================== -->
  <section id="view_barra" class="tile hidden">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Barra / Granizados</h6>
      <button class="btn btn-outline-secondary btn-sm" data-goto="home">Volver</button>
    </div>

    <div class="row g-3">
      <!-- Inventario -->
      <div class="col-xl-6">
        <div class="tile mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Inventario del día</div>
            <div style="max-width:220px" class="d-flex gap-2">
              <select id="inv_pos" class="form-select form-select-sm">
                <option>Barra</option><option>Granizados</option>
              </select>
              <button id="btnInvCargar" class="btn btn-outline-primary btn-sm">Cargar catálogo POS</button>
            </div>
          </div>

          <div class="mt-3">
            <div class="fw-medium">Contar stock inicial (editar cantidades)</div>
            <div class="table-responsive" style="max-height:280px;overflow:auto">
              <table class="table table-sm">
                <thead><tr><th>SKU</th><th>Producto</th><th class="text-end" style="width:120px">Cant.</th></tr></thead>
                <tbody id="inv_body_inicial"></tbody>
              </table>
            </div>
            <button id="btnInvSaveInicial" class="btn btn-outline-dark w-100">Guardar inventario inicial</button>
          </div>

          <hr>
          <div class="mt-3">
            <div class="fw-medium">Contar stock final</div>
            <div class="table-responsive" style="max-height:240px;overflow:auto">
              <table class="table table-sm">
                <thead><tr><th>SKU</th><th>Producto</th><th class="text-end" style="width:120px">Cant.</th></tr></thead>
                <tbody id="inv_body_final"></tbody>
              </table>
            </div>
            <button id="btnInvSaveFinal" class="btn btn-outline-dark w-100">Guardar inventario final</button>
          </div>
        </div>
      </div>

      <!-- Compras / Gastos / Nómina -->
      <div class="col-xl-6">
        <div class="tile mb-3">
          <div class="fw-semibold mb-2">Compras / Reposición</div>
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label">SKU</label>
              <select id="c_sku" class="form-select"></select>
              <div class="form-text">o deja “Libre” y escribe en Nota.</div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Cant.</label>
              <input id="c_cant" type="number" min="1" value="1" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">PU</label>
              <input id="c_pu" type="number" min="0" step="100" value="0" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">POS</label>
              <select id="c_pos" class="form-select">
                <option>Barra</option><option>Granizados</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Notas</label>
              <input id="c_notas" type="text" class="form-control" placeholder="Factura, proveedor o producto libre">
            </div>
            <div class="col-12">
              <button id="btnAddCompra" class="btn btn-primary w-100">Agregar compra</button>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle">
              <thead><tr><th>Fecha</th><th>SKU</th><th>Prod</th><th>Cant</th><th>PU</th><th>Total</th><th>POS</th><th>Notas</th><th></th></tr></thead>
              <tbody id="tblCompras"></tbody>
            </table>
          </div>
        </div>

        <div class="tile mb-3">
          <div class="fw-semibold mb-2">Gastos</div>
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Tipo</label>
              <select id="g_tipo" class="form-select">
                <option>Gasto</option>
                <option>Socio</option>
                <option>Operación</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Concepto</label>
              <input id="g_concepto" type="text" class="form-control" placeholder="Concepto">
            </div>
            <div class="col-md-2">
              <label class="form-label">Valor</label>
              <input id="g_valor" type="number" min="0" step="100" value="0" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">POS</label>
              <select id="g_pos" class="form-select"><option>Barra</option><option>Granizados</option></select>
            </div>
            <div class="col-12">
              <label class="form-label">Socio/Persona (atribución)</label>
              <input id="g_atr" type="text" class="form-control" placeholder="Opcional: a quién se le atribuye">
            </div>
            <div class="col-12">
              <label class="form-label">Notas</label>
              <input id="g_notas" type="text" class="form-control" placeholder="Detalle opcional">
            </div>
            <div class="col-12">
              <button id="btnAddGasto" class="btn btn-warning w-100">Agregar gasto</button>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle">
              <thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Valor</th><th>Atribuido</th><th>POS</th><th>Notas</th><th></th></tr></thead>
              <tbody id="tblGastos"></tbody>
            </table>
          </div>
        </div>

        <div class="tile">
          <div class="fw-semibold mb-2">Nómina (día)</div>
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Empleado</label>
              <input id="n_emp" type="text" class="form-control" placeholder="Nombre">
            </div>
            <div class="col-md-3">
              <label class="form-label">Función</label>
              <select id="n_rol" class="form-select">
                <option>Barra</option><option>Mesero</option><option>Granizados</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor</label>
              <input id="n_valor" type="number" min="0" step="100" value="0" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label d-block">&nbsp;</label>
              <button id="btnAddNomina" class="btn btn-dark w-100">Agregar</button>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle">
              <thead><tr><th>Fecha</th><th>Empleado</th><th>Función</th><th>Valor</th><th>Notas</th><th></th></tr></thead>
              <tbody id="tblNomina"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== SOCIOS ====================== -->
  <section id="view_socios" class="tile hidden">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Socios: KPIs, cierres y reparto</h6>
      <button class="btn btn-outline-secondary btn-sm" data-goto="home">Volver</button>
    </div>

    <div class="tile mb-3">
      <div class="fw-semibold mb-2">Participación de socios</div>
      <div id="sociosWrap" class="d-flex flex-column gap-2"></div>
      <div class="d-flex gap-2 mt-2">
        <input id="s_nuevo" class="form-control" placeholder="Nombre socio">
        <input id="s_pct" class="form-control" type="number" min="0" max="100" value="0" style="max-width:120px">
        <button id="btnAddSocio" class="btn btn-outline-primary">Agregar socio</button>
      </div>
      <div class="form-text">El reparto se calcula después de Gastos, Compras y Nómina.</div>
    </div>

    <div class="tile mb-3">
      <div class="fw-semibold mb-2">Cierre diario</div>
      <div class="d-flex gap-2 align-items-end">
        <input id="cierre_dia" type="date" class="form-control" style="max-width:220px">
        <button id="btnCierreDia" class="btn btn-dark">Generar</button>
      </div>
      <div id="cierreDiaOut" class="mt-3"></div>
    </div>

    <div class="tile">
      <div class="fw-semibold mb-2">Cierre semanal + reparto por socio</div>
      <div class="row g-2 align-items-end">
        <div class="col-md-3"><label class="form-label">Desde</label><input id="cw_desde" type="date" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Hasta</label><input id="cw_hasta" type="date" class="form-control"></div>
        <div class="col-md-6">
          <label class="form-label">Gastos de cierre (semanales)</label>
          <input id="cw_gasto" type="number" min="0" step="100" value="0" class="form-control" placeholder="Si hubo gastos extra de cierre, pon el total aquí">
        </div>
        <div class="col-12">
          <button id="btnCierreSemanal" class="btn btn-dark w-100">Generar reparto</button>
        </div>
      </div>
      <div id="cierreSemanalOut" class="mt-3"></div>
    </div>
  </section>

  <!-- ====================== HISTORIAL ====================== -->
  <section id="view_historial" class="tile hidden">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Historial / Reportes por rango</h6>
      <button class="btn btn-outline-secondary btn-sm" data-goto="home">Volver</button>
    </div>

    <div class="row g-2">
      <div class="col-md-3"><label class="form-label">Desde</label><input id="h_desde" type="date" class="form-control"></div>
      <div class="col-md-3"><label class="form-label">Hasta</label><input id="h_hasta" type="date" class="form-control"></div>
      <div class="col-md-3 d-flex align-items-end"><button id="btnHistorial" class="btn btn-primary w-100">Consultar</button></div>
    </div>

    <div id="historialOut" class="mt-3"></div>
  </section>

  <!-- ====================== CIERRES ====================== -->
  <section id="view_cierres" class="tile hidden">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Cierres</h6>
      <button class="btn btn-outline-secondary btn-sm" data-goto="home">Volver</button>
    </div>

    <div class="tile mb-3">
      <div class="fw-semibold mb-2">Gastos de la semana (para cierre)</div>
      <div class="row g-2">
        <div class="col-md-3"><label class="form-label">Desde</label><input id="cs_desde" type="date" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Hasta</label><input id="cs_hasta" type="date" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Total gastos extra</label><input id="cs_extra" type="number" min="0" step="100" value="0" class="form-control"></div>
        <div class="col-md-3 d-flex align-items-end"><button id="btnCierreSemanal2" class="btn btn-dark w-100">Generar</button></div>
      </div>
      <div id="cierreSemanalOut2" class="mt-3"></div>
    </div>
  </section>

</div>

<div class="sticky-footer">PWA lista para “Agregar a pantalla de inicio”. Datos guardados en Supabase.</div>

<!-- libs -->
<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script>dayjs.extend(window.dayjs_plugin_customParseFormat);</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ----------------- SUPABASE -----------------
let supabase;
(function initSupabase(){
  const url = window.SUPABASE_URL || window.NEXT_PUBLIC_SUPABASE_URL;
  const key = window.SUPABASE_ANON_KEY || window.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  if(!url || !key){
    alert("Faltan credenciales de Supabase. Crea un archivo config.js con SUPABASE_URL y SUPABASE_ANON_KEY.");
  } else {
    supabase = window.supabase.createClient(url, key);
  }
})();

// ----------------- STATE -----------------
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => (n||0).toLocaleString('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0});
const today = () => dayjs().format('YYYY-MM-DD');
$("#fechaActiva").value = today();

// NAV
$$("[data-goto]").forEach(b=> b.addEventListener("click", () => goto(b.dataset.goto)));
function goto(id){
  ["home","ventas","barra","socios","historial","cierres"].forEach(v => $("#view_"+v).classList.add("hidden"));
  $("#view_"+id).classList.remove("hidden");
}

// Helpers
function toast(msg, type="primary"){
  const el = document.createElement("div");
  el.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 2500);
}

// ----------------- KPI DEL DÍA -----------------
async function loadKPIs(){
  const f = $("#fechaActiva").value;
  const [{ data: ventas }, { data: gastos }, { data: compras }, { data: nomina }] = await Promise.all([
    supabase.from("ventas").select("metodo_pago,monto").eq("fecha", f),
    supabase.from("gastos").select("valor").eq("fecha", f),
    supabase.from("compras").select("total").eq("fecha", f),
    supabase.from("nomina").select("valor").eq("fecha", f)
  ]);

  const totalVentas = (ventas||[]).reduce((acc,v)=> acc + (v.monto||0),0);
  const efec = (ventas||[]).filter(v=>v.metodo_pago==="Efectivo").reduce((a,v)=>a+v.monto,0);
  const trf  = (ventas||[]).filter(v=>v.metodo_pago==="Transferencia").reduce((a,v)=>a+v.monto,0);
  const tg   = (gastos||[]).reduce((a,g)=>a+(g.valor||0),0);
  const tc   = (compras||[]).reduce((a,c)=>a+(c.total||0),0);
  const tn   = (nomina||[]).reduce((a,n)=>a+(n.valor||0),0);
  const util = totalVentas - tg - tc - tn;

  $("#kpiVentas").textContent = fmt(totalVentas);
  $("#kpiEfectivo").textContent= fmt(efec);
  $("#kpiTransf").textContent  = fmt(trf);
  $("#kpiGastos").textContent  = fmt(tg);
  $("#kpiCompras").textContent = fmt(tc);
  $("#kpiNomina").textContent  = fmt(tn);
  $("#kpiUtilidad").textContent= fmt(util);
}

// ----------------- CATALOGO -----------------
let catalogo = []; // {sku, prod, pu, pos}
async function loadCatalogo(pos){
  const { data, error } = await supabase.from("catalogo").select("*").eq("pos", pos);
  if(error){ toast("Error cargando catálogo: "+error.message, "danger"); return; }
  catalogo = data||[];
  // Ventas select
  const s = $("#v_sku"); s.innerHTML="";
  catalogo.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.sku;
    opt.textContent = `${c.prod} (${c.sku})`;
    s.appendChild(opt);
  });
  // Compras select
  const csel = $("#c_sku"); csel.innerHTML="";
  const optLibre = document.createElement("option"); optLibre.value="__LIBRE__"; optLibre.textContent="Libre (escribe en Nota)";
  csel.appendChild(optLibre);
  catalogo.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.sku;
    opt.textContent = `${c.prod} (${c.sku})`;
    csel.appendChild(opt);
  });
  setPU();
}

$("#btnCargarCatalogo").addEventListener("click", ()=> loadCatalogo($("#v_pos").value));
$("#inv_pos").addEventListener("change", ()=> loadCatalogo($("#inv_pos").value));
$("#v_pos").addEventListener("change", ()=> loadCatalogo($("#v_pos").value));
$("#c_pos").addEventListener("change", ()=> loadCatalogo($("#c_pos").value));
$("#btnInvCargar").addEventListener("click", ()=> loadCatalogo($("#inv_pos").value));

$("#v_sku").addEventListener("change", setPU);
function setPU(){
  const sku = $("#v_sku").value;
  const c = catalogo.find(x=>x.sku===sku);
  $("#v_pu").value = c?.pu || 0;
}

// ----------------- VENTAS -----------------
$("#v_pago").addEventListener("change", ()=>{
  const mixto = $("#v_pago").value==="Mixto";
  $$(".v_mixto").forEach(x=> x.classList.toggle("hidden", !mixto));
});

$("#btnAddVenta").addEventListener("click", async ()=>{
  const f = $("#fechaActiva").value;
  const pos = $("#v_pos").value;
  const sku = $("#v_sku").value;
  const c = catalogo.find(x=>x.sku===sku) || {};
  const cant = +$("#v_cant").value||1;
  const pu   = +$("#v_pu").value||0;
  const pago = $("#v_pago").value;
  const nota = $("#v_notas").value||"";
  const hora = dayjs().format("HH:mm:ss");

  try{
    if(pago==="Mixto"){
      const ef = +$("#v_efectivo").value||0;
      const tr = +$("#v_transf").value||0;
      if(ef+tr !== cant*pu){ return alert("El total Mixto debe coincidir con Cant * PU"); }
      const payload = [
        {fecha:f,hora, pos, sku, prod:c.prod||sku, cant, metodo_pago:"Efectivo", monto:ef, nota},
        {fecha:f,hora, pos, sku, prod:c.prod||sku, cant, metodo_pago:"Transferencia", monto:tr, nota}
      ];
      const { error } = await supabase.from("ventas").insert(payload);
      if(error) throw error;
    } else {
      const total = cant*pu;
      const { error } = await supabase.from("ventas").insert({fecha:f,hora,pos,sku,prod:c.prod||sku,cant,metodo_pago:pago,monto:total,nota});
      if(error) throw error;
    }
    toast("Venta guardada","success");
    $("#v_cant").value=1; $("#v_notas").value=""; $("#v_efectivo").value=0; $("#v_transf").value=0;
    await refreshVentas();
    await loadKPIs();
  }catch(err){ alert("Error guardando venta: "+err); }
});

async function refreshVentas(){
  const f = $("#fechaActiva").value;
  const { data, error } = await supabase.from("ventas").select("*").eq("fecha", f).order("hora",{ascending:false});
  if(error){ toast("Error cargando ventas: "+error.message, "danger"); return; }
  const tb = $("#tblVentas"); tb.innerHTML="";
  (data||[]).forEach(v=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.fecha}</td><td>${v.hora||""}</td><td>${v.pos||""}</td><td>${v.sku||""}</td>
    <td>${v.prod||""}</td><td>${v.cant||0}</td><td>${v.metodo_pago}</td><td>${fmt(v.monto)}</td><td>${v.nota||""}</td>
    <td><button class="btn btn-sm btn-outline-danger" data-delv="${v.id}">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("[data-delv]").forEach(b=> b.addEventListener("click", async ()=>{
    const id=b.dataset.delv; if(!confirm("Eliminar venta?")) return;
    const { error } = await supabase.from("ventas").delete().eq("id", id);
    if(error){ toast("No se pudo eliminar","danger"); return; }
    refreshVentas(); loadKPIs();
  }));
}

// ----------------- INVENTARIO -----------------
function renderInvTable(targetId){
  const body = $(targetId); body.innerHTML="";
  catalogo.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c.sku}</td><td>${c.prod}</td>
      <td class="text-end"><input type="number" min="0" value="0" class="form-control form-control-sm inv-cant" data-sku="${c.sku}" style="max-width:100px; margin-left:auto"></td>`;
    body.appendChild(tr);
  });
}
$("#btnInvCargar").addEventListener("click", ()=> { renderInvTable("#inv_body_inicial"); renderInvTable("#inv_body_final"); });

$("#btnInvSaveInicial").addEventListener("click", ()=> saveInv("inicial"));
$("#btnInvSaveFinal").addEventListener("click", ()=> saveInv("final"));

async function saveInv(tipo){
  const pos = $("#inv_pos").value;
  const fecha = $("#fechaActiva").value;
  const selector = tipo==="inicial" ? "#inv_body_inicial .inv-cant" : "#inv_body_final .inv-cant";
  const detalle = Array.from(document.querySelectorAll(selector)).map(x => ({sku:x.dataset.sku, cant:+x.value}));
  const payload = { fecha, pos, tipo, detalle };
  const { error } = await supabase.from("inv_conteo").insert(payload);
  if(error){ toast("Error guardando inventario: "+error.message,"danger"); return; }
  toast("Inventario "+tipo+" guardado","success");
}

// ----------------- COMPRAS -----------------
$("#btnAddCompra").addEventListener("click", async ()=>{
  const f = $("#fechaActiva").value;
  const sku = $("#c_sku").value;
  const cant = +$("#c_cant").value||1;
  const pu = +$("#c_pu").value||0;
  const total = cant*pu;
  const pos = $("#c_pos").value;
  const notas = $("#c_notas").value||"";
  const prod = sku==="__LIBRE__" ? notas : (catalogo.find(x=>x.sku===sku)?.prod || sku);
  try{
    const { error } = await supabase.from("compras").insert({fecha:f, sku: (sku==="__LIBRE__"? null : sku), prod, cant, pu, total, pos, nota:notas});
    if(error) throw error;
    toast("Compra guardada","success");
    $("#c_notas").value=""; $("#c_cant").value=1; $("#c_pu").value=0;
    refreshCompras(); loadKPIs();
  }catch(err){ alert("Error guardando compra: "+err); }
});

async function refreshCompras(){
  const f = $("#fechaActiva").value;
  const { data, error } = await supabase.from("compras").select("*").eq("fecha", f).order("id",{ascending:false});
  if(error){ toast("Error cargando compras: "+error.message,"danger"); return; }
  const tb = $("#tblCompras"); tb.innerHTML="";
  (data||[]).forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c.fecha}</td><td>${c.sku||""}</td><td>${c.prod||""}</td>
      <td>${c.cant||0}</td><td>${fmt(c.pu||0)}</td><td>${fmt(c.total||0)}</td><td>${c.pos||""}</td><td>${c.nota||""}</td>
      <td><button class="btn btn-sm btn-outline-danger" data-delc="${c.id}">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("[data-delc]").forEach(b=> b.addEventListener("click", async ()=>{
    const id=b.dataset.delc; if(!confirm("Eliminar compra?")) return;
    const { error } = await supabase.from("compras").delete().eq("id", id);
    if(error){ toast("No se pudo eliminar compra","danger"); return; }
    refreshCompras(); loadKPIs();
  }));
}

// ----------------- GASTOS -----------------
$("#btnAddGasto").addEventListener("click", async ()=>{
  const f = $("#fechaActiva").value;
  const tipo = $("#g_tipo").value;
  const concepto = $("#g_concepto").value||"";
  const valor = +$("#g_valor").value||0;
  const pos = $("#g_pos").value;
  const atr = $("#g_atr").value||"";
  const notas = $("#g_notas").value||"";
  try{
    const { error } = await supabase.from("gastos").insert({fecha:f,tipo,concepto,valor,atribuido:atr,pos,notas});
    if(error) throw error;
    toast("Gasto guardado","success");
    $("#g_concepto").value=""; $("#g_valor").value=0; $("#g_atr").value=""; $("#g_notas").value="";
    refreshGastos(); loadKPIs();
    if(tipo==="Socio"){
      // Cargo a deudas de socio
      await supabase.from("deudas").insert({fecha:f,tipo:"socio",ref_nombre:atr || "Socio", motivo:concepto, valor, saldo:valor});
    }
  }catch(err){ alert("Error guardando gasto: "+err); }
});

async function refreshGastos(){
  const f = $("#fechaActiva").value;
  const { data, error } = await supabase.from("gastos").select("*").eq("fecha", f).order("id",{ascending:false});
  if(error){ toast("Error cargando gastos: "+error.message,"danger"); return; }
  const tb = $("#tblGastos"); tb.innerHTML="";
  (data||[]).forEach(g=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${g.fecha}</td><td>${g.tipo||""}</td><td>${g.concepto||""}</td><td>${fmt(g.valor||0)}</td>
      <td>${g.atribuido||""}</td><td>${g.pos||""}</td><td>${g.notas||""}</td>
      <td><button class="btn btn-sm btn-outline-danger" data-delg="${g.id}">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("[data-delg]").forEach(b=> b.addEventListener("click", async ()=>{
    const id=b.dataset.delg; if(!confirm("Eliminar gasto?")) return;
    const { error } = await supabase.from("gastos").delete().eq("id", id);
    if(error){ toast("No se pudo eliminar gasto","danger"); return; }
    refreshGastos(); loadKPIs();
  }));
}

// ----------------- NOMINA -----------------
$("#btnAddNomina").addEventListener("click", async ()=>{
  const f = $("#fechaActiva").value;
  const emp = $("#n_emp").value.trim();
  const rol = $("#n_rol").value;
  const valor = +$("#n_valor").value||0;
  if(!emp) return alert("Escribe el nombre del empleado");
  try{
    const { error } = await supabase.from("nomina").insert({fecha:f, empleado:emp, rol, valor, notas:""});
    if(error) throw error;
    toast("Nómina guardada","success");
    $("#n_emp").value=""; $("#n_valor").value=0;
    refreshNomina(); loadKPIs();
  }catch(err){ alert("Error guardando nómina: "+err); }
});

async function refreshNomina(){
  const f = $("#fechaActiva").value;
  const { data, error } = await supabase.from("nomina").select("*").eq("fecha", f).order("id",{ascending:false});
  if(error){ toast("Error cargando nómina: "+error.message,"danger"); return; }
  const tb = $("#tblNomina"); tb.innerHTML="";
  (data||[]).forEach(n=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${n.fecha}</td><td>${n.empleado||""}</td><td>${n.rol||""}</td><td>${fmt(n.valor||0)}</td><td>${n.notas||""}</td>
      <td><button class="btn btn-sm btn-outline-danger" data-deln="${n.id}">🗑</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("[data-deln]").forEach(b=> b.addEventListener("click", async ()=>{
    const id=b.dataset.deln; if(!confirm("Eliminar registro de nómina?")) return;
    const { error } = await supabase.from("nomina").delete().eq("id", id);
    if(error){ toast("No se pudo eliminar","danger"); return; }
    refreshNomina(); loadKPIs();
  }));
}

// ----------------- SOCIOS -----------------
async function loadSocios(){
  const { data } = await supabase.from("socios").select("*").order("id");
  const wrap = $("#sociosWrap"); wrap.innerHTML="";
  (data||[]).forEach(s => {
    const row = document.createElement("div");
    row.className="d-flex gap-2";
    row.innerHTML = `<input class="form-control" value="${s.nombre}" data-socio="${s.id}" data-field="nombre">
    <input class="form-control" style="max-width:120px" type="number" min="0" max="100" value="${s.porcentaje||0}" data-socio="${s.id}" data-field="porcentaje">
    <button class="btn btn-outline-danger btn-sm" data-del-socio="${s.id}">X</button>`;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll("[data-socio]").forEach(inp=> inp.addEventListener("change", async ()=>{
    const id=inp.dataset.socio, field=inp.dataset.field, value=inp.value;
    await supabase.from("socios").update({[field]: field==="porcentaje" ? +value : value}).eq("id", id);
  }));
  wrap.querySelectorAll("[data-del-socio]").forEach(b=> b.addEventListener("click", async ()=>{
    const id=b.dataset.delSocio; if(!confirm("Eliminar socio?")) return;
    await supabase.from("socios").delete().eq("id", id); loadSocios();
  }));
}
$("#btnAddSocio").addEventListener("click", async ()=>{
  const nombre=$("#s_nuevo").value.trim(); const pct= +$("#s_pct").value||0;
  if(!nombre) return;
  await supabase.from("socios").insert({nombre, porcentaje:pct}); $("#s_nuevo").value=""; $("#s_pct").value=0; loadSocios();
});

$("#btnCierreDia").addEventListener("click", async ()=>{
  const f = $("#cierre_dia").value; if(!f) return alert("Selecciona una fecha");
  const res = await resumenRango(f, f);
  $("#cierreDiaOut").innerHTML = renderResumenHtml(res);
});

$("#btnCierreSemanal").addEventListener("click", async ()=>{
  const d=$("#cw_desde").value, h=$("#cw_hasta").value; if(!d||!h) return alert("Fechas incompletas");
  const res = await resumenRango(d,h);
  const extra = +$("#cw_gasto").value||0;
  res.gastos += extra; res.utilidad -= extra;
  $("#cierreSemanalOut").innerHTML = renderResumenHtml(res,true);
});

// ----------------- HISTORIAL -----------------
$("#btnHistorial").addEventListener("click", async ()=>{
  const d=$("#h_desde").value, h=$("#h_hasta").value; if(!d||!h) return alert("Fechas incompletas");
  const res = await resumenRango(d,h,true);
  $("#historialOut").innerHTML = renderResumenHtml(res,true,true);
});

// ----------------- CIERRES pantalla extra -----------------
$("#btnCierreSemanal2").addEventListener("click", async ()=>{
  const d=$("#cs_desde").value, h=$("#cs_hasta").value; if(!d||!h) return alert("Fechas incompletas");
  const res = await resumenRango(d,h);
  const extra = +$("#cs_extra").value||0;
  res.gastos += extra; res.utilidad -= extra;
  $("#cierreSemanalOut2").innerHTML = renderResumenHtml(res,true);
});

// ----------------- RESUMEN / CONSULTAS -----------------
async function resumenRango(desde, hasta, withRows=false){
  const queries = [
    supabase.from("ventas").select(withRows?"*":"monto,metodo_pago,fecha").gte("fecha", desde).lte("fecha", hasta),
    supabase.from("gastos").select(withRows?"*":"valor,tipo,fecha").gte("fecha", desde).lte("fecha", hasta),
    supabase.from("compras").select(withRows?"*":"total,fecha").gte("fecha", desde).lte("fecha", hasta),
    supabase.from("nomina").select(withRows?"*":"valor,fecha").gte("fecha", desde).lte("fecha", hasta),
  ];
  const [{data: v},{data:g},{data:c},{data:n}] = await Promise.all(queries);
  const totalVentas = (v||[]).reduce((a,x)=>a+(x.monto||0),0);
  const ef = (v||[]).filter(x=>x.metodo_pago==="Efectivo").reduce((a,x)=>a+x.monto,0);
  const tr = (v||[]).filter(x=>x.metodo_pago==="Transferencia").reduce((a,x)=>a+x.monto,0);
  const tg = (g||[]).reduce((a,x)=>a+(x.valor||0),0);
  const tc = (c||[]).reduce((a,x)=>a+(x.total||0),0);
  const tn = (n||[]).reduce((a,x)=>a+(x.valor||0),0);
  const util = totalVentas - tg - tc - tn;
  return {desde, hasta, totalVentas, ef, tr, gastos:tg, compras:tc, nomina:tn, utilidad:util, v, g, c, n};
}

function renderResumenHtml(r, showSocios=false, withTables=false){
  let html=`
  <div class="row g-3">
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Ventas</div><div class="fs-6 fw-semibold">${fmt(r.totalVentas)}</div></div></div>
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Efectivo</div><div class="fs-6 fw-semibold">${fmt(r.ef)}</div></div></div>
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Transf.</div><div class="fs-6 fw-semibold">${fmt(r.tr)}</div></div></div>
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Gastos</div><div class="fs-6 fw-semibold">${fmt(r.gastos)}</div></div></div>
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Compras</div><div class="fs-6 fw-semibold">${fmt(r.compras)}</div></div></div>
    <div class="col-md-3"><div class="tile"><div class="text-secondary small">Nómina</div><div class="fs-6 fw-semibold">${fmt(r.nomina)}</div></div></div>
    <div class="col-md-3"><div class="tile bg-success-subtle"><div class="text-secondary small">Utilidad</div><div class="fs-6 fw-semibold">${fmt(r.utilidad)}</div></div></div>
  </div>`;

  if(showSocios){
    html += `<hr><div id="repartoSocios"></div>`;
    renderRepartoSocios(r.utilidad);
  }
  if(withTables){
    html += `
    <hr>
    <div class="mt-3">
      <h6>Ventas</h6>
      <div class="table-responsive"><table class="table table-sm"><thead><tr>
        <th>Fecha</th><th>Hora</th><th>POS</th><th>SKU</th><th>Prod</th><th>Cant</th><th>Pago</th><th>Monto</th><th>Nota</th>
      </tr></thead><tbody>${
        (r.v||[]).map(x=>`<tr><td>${x.fecha}</td><td>${x.hora||""}</td><td>${x.pos||""}</td><td>${x.sku||""}</td><td>${x.prod||""}</td><td>${x.cant||0}</td><td>${x.metodo_pago}</td><td>${fmt(x.monto)}</td><td>${x.nota||""}</td></tr>`).join("")
      }</tbody></table></div>

      <h6>Compras</h6>
      <div class="table-responsive"><table class="table table-sm"><thead><tr>
        <th>Fecha</th><th>SKU</th><th>Prod</th><th>Cant</th><th>PU</th><th>Total</th><th>POS</th><th>Nota</th>
      </tr></thead><tbody>${
        (r.c||[]).map(x=>`<tr><td>${x.fecha}</td><td>${x.sku||""}</td><td>${x.prod||""}</td><td>${x.cant||0}</td><td>${fmt(x.pu||0)}</td><td>${fmt(x.total||0)}</td><td>${x.pos||""}</td><td>${x.nota||""}</td></tr>`).join("")
      }</tbody></table></div>

      <h6>Gastos</h6>
      <div class="table-responsive"><table class="table table-sm"><thead><tr>
        <th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Valor</th><th>Atribuido</th><th>POS</th><th>Notas</th>
      </tr></thead><tbody>${
        (r.g||[]).map(x=>`<tr><td>${x.fecha}</td><td>${x.tipo||""}</td><td>${x.concepto||""}</td><td>${fmt(x.valor||0)}</td><td>${x.atribuido||""}</td><td>${x.pos||""}</td><td>${x.notas||""}</td></tr>`).join("")
      }</tbody></table></div>

      <h6>Nómina</h6>
      <div class="table-responsive"><table class="table table-sm"><thead><tr>
        <th>Fecha</th><th>Empleado</th><th>Rol</th><th>Valor</th><th>Notas</th>
      </tr></thead><tbody>${
        (r.n||[]).map(x=>`<tr><td>${x.fecha}</td><td>${x.empleado||""}</td><td>${x.rol||""}</td><td>${fmt(x.valor||0)}</td><td>${x.notas||""}</td></tr>`).join("")
      }</tbody></table></div>
    </div>`;
  }

  return html;
}

async function renderRepartoSocios(utilidad){
  const { data } = await supabase.from("socios").select("*");
  const wrap = $("#repartoSocios"); wrap.innerHTML="";
  const totalPct = (data||[]).reduce((a,x)=>a+(x.porcentaje||0),0);
  let html = `<div class="table-responsive"><table class="table table-sm">
  <thead><tr><th>Socio</th><th>%</th><th>Ganancia</th><th>Deuda (cargos)</th><th>Saldo</th></tr></thead><tbody>`;
  const { data: ds } = await supabase.from("deudas").select("tipo,ref_nombre,saldo").eq("tipo","socio");
  (data||[]).forEach(s=>{
    const part = utilidad * ((s.porcentaje||0)/100);
    const deuda = (ds||[]).filter(x=>x.ref_nombre===s.nombre).reduce((a,x)=>a+(x.saldo||0),0);
    html += `<tr><td>${s.nombre}</td><td>${s.porcentaje||0}%</td><td>${fmt(part)}</td><td>${fmt(deuda)}</td><td>${fmt(part - deuda)}</td></tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;
}

// ----------------- DEUDAS LISTAS EN HOME -----------------
async function loadDeudas(){
  const { data } = await supabase.from("deudas").select("*");
  const emp = (data||[]).filter(x=>x.tipo==="empleado");
  const soc = (data||[]).filter(x=>x.tipo==="socio");
  $("#listaDeudasEmpleados").innerHTML = emp.map(x=>`<li class="list-group-item d-flex justify-content-between align-items-center">
    <span>${x.ref_nombre} — ${x.motivo||"descuadre"}</span><span class="fw-semibold">${fmt(x.saldo||0)}</span>
  </li>`).join("") || `<li class="list-group-item">Sin deudas</li>`;
  $("#listaDeudasSocios").innerHTML = soc.map(x=>`<li class="list-group-item d-flex justify-content-between align-items-center">
    <span>${x.ref_nombre} — ${x.motivo||"cargo"}</span><span class="fw-semibold">${fmt(x.saldo||0)}</span>
  </li>`).join("") || `<li class="list-group-item">Sin deudas</li>`;
}

// ----------------- EXPORTS -----------------
$("#btnExportXLSX").addEventListener("click", async ()=>{
  const d = $("#h_desde").value || $("#fechaActiva").value;
  const h = $("#h_hasta").value || $("#fechaActiva").value;
  const r = await resumenRango(d,h,true);
  const wb = XLSX.utils.book_new();
  const toSheet = (rows, headersMap) => {
    const arr = rows.map(x=>{
      const obj={};
      for(const [label, key] of headersMap) obj[label] = x[key] ?? "";
      return obj;
    });
    return XLSX.utils.json_to_sheet(arr);
  };
  XLSX.utils.book_append_sheet(wb, toSheet(r.v||[], [["Fecha","fecha"],["Hora","hora"],["POS","pos"],["SKU","sku"],["Prod","prod"],["Cant","cant"],["Pago","metodo_pago"],["Monto","monto"],["Nota","nota"]]), "Ventas");
  XLSX.utils.book_append_sheet(wb, toSheet(r.c||[], [["Fecha","fecha"],["SKU","sku"],["Prod","prod"],["Cant","cant"],["PU","pu"],["Total","total"],["POS","pos"],["Nota","nota"]]), "Compras");
  XLSX.utils.book_append_sheet(wb, toSheet(r.g||[], [["Fecha","fecha"],["Tipo","tipo"],["Concepto","concepto"],["Valor","valor"],["Atribuido","atribuido"],["POS","pos"],["Notas","notas"]]), "Gastos");
  XLSX.utils.book_append_sheet(wb, toSheet(r.n||[], [["Fecha","fecha"],["Empleado","empleado"],["Rol","rol"],["Valor","valor"],["Notas","notas"]]), "Nomina");
  XLSX.writeFile(wb, `reporte_${d}_a_${h}.xlsx`);
});

$("#btnExportPDF").addEventListener("click", async ()=>{
  const d = $("#h_desde").value || $("#fechaActiva").value;
  const h = $("#h_hasta").value || $("#fechaActiva").value;
  const r = await resumenRango(d,h,false);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt"});
  doc.setFontSize(14);
  doc.text(`Reporte ${d} a ${h}`, 40, 40);
  doc.setFontSize(11);
  const lines = [
    `Ventas: ${fmt(r.totalVentas)}  (Efectivo: ${fmt(r.ef)} · Transf: ${fmt(r.tr)})`,
    `Compras: ${fmt(r.compras)}   Gastos: ${fmt(r.gastos)}   Nómina: ${fmt(r.nomina)}`,
    `Utilidad: ${fmt(r.utilidad)}`
  ];
  lines.forEach((t,i)=> doc.text(t, 40, 70 + i*18));
  doc.save(`reporte_${d}_a_${h}.pdf`);
});

// ----------------- RESET / FECHA -----------------
$("#fechaActiva").addEventListener("change", async ()=>{
  await Promise.all([refreshVentas(), refreshCompras(), refreshGastos(), refreshNomina(), loadKPIs()]);
});
$("#btnReset").addEventListener("click", async ()=>{
  $("#fechaActiva").value = today();
  goto("home");
  await Promise.all([refreshVentas(), refreshCompras(), refreshGastos(), refreshNomina(), loadKPIs()]);
});

// ----------------- INIT -----------------
(async function init(){
  goto("home");
  await loadCatalogo("Barra");
  renderInvTable("#inv_body_inicial");
  renderInvTable("#inv_body_final");
  await Promise.all([refreshVentas(), refreshCompras(), refreshGastos(), refreshNomina(), loadSocios(), loadKPIs(), loadDeudas()]);
})();
</script>
</body>
</html>