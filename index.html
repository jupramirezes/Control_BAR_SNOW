<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Bar Control • PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    :root { --pad: 14px; }
    body { background:#f7f7f8; }
    .app { max-width: 1080px; margin: 0 auto; padding: var(--pad); }
    .tile { padding: 16px; border-radius: 16px; border:1px solid #eee; background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .btn-fat { padding: 14px 16px; font-size: 18px; border-radius: 14px; }
    .kpi { border-radius: 14px; padding: 10px 12px; background:#fff; border: 1px solid #eee; }
    .kpi .v { font-weight:700; font-size: 18px; }
    .pos-pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#111; color:#fff; }
    .pos-Barra { background: #0d6efd; }
    .pos-Granizados { background: #198754; }
    .table-sm td, .table-sm th { padding: .45rem .5rem; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #eee; padding: 8px 12px; z-index: 1000; }
  </style>
</head>
<body>
<div class="app">
  <header class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="m-0">Control Bar / Discoteca · PWA</h4>
    <div class="d-flex gap-2">
      <button id="btnExportXLSX" class="btn btn-sm btn-outline-primary">Excel</button>
      <button id="btnExportPDF" class="btn btn-sm btn-outline-danger">PDF</button>
      <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset</button>
    </div>
  </header>

  <!-- HOME ROLES -->
  <section id="home" class="tile">
    <div class="mb-3">
      <label class="form-label">Soy:</label>
      <div class="row g-2">
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="mesero">Mesero (Ventas Rápidas)</button></div>
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="pos">Barra / Granizados (Inventario · Compras · Gastos)</button></div>
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="socios">Socios (KPIs · Cierres · Distribución)</button></div>
      </div>
    </div>
    <div class="row g-2">
      <div class="col-6 col-md-3"><div class="kpi"><div class="t text-muted">Ventas hoy</div><div class="v" id="kpiVentas">$0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="t text-muted">Efectivo</div><div class="v" id="kpiEfec">$0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="t text-muted">Transf.</div><div class="v" id="kpiTransf">$0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="t text-muted">Utilidad hoy</div><div class="v" id="kpiUtil">$0</div></div></div>
    </div>
  </section>

  <!-- MESERO -->
  <section id="mesero" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Ventas rápidas (Mesero)</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <label class="form-label">POS</label>
        <select id="ventaPOS" class="form-select form-select-lg">
          <option>Barra</option><option>Granizados</option>
        </select>
      </div>
      <div class="col-6">
        <label class="form-label">Producto</label>
        <select id="ventaSku" class="form-select form-select-lg"></select>
      </div>
      <div class="col-4">
        <label class="form-label">Cant.</label>
        <input id="ventaCant" type="number" class="form-control form-control-lg" min="1" value="1"/>
      </div>
      <div class="col-4">
        <label class="form-label">Pago</label>
        <select id="ventaPago" class="form-select form-select-lg"><option>Efectivo</option><option>Transferencia</option></select>
      </div>
      <div class="col-4">
        <label class="form-label">Notas</label>
        <input id="ventaNotas" class="form-control form-control-lg" placeholder="Ej: Mesa 4 / promo"/>
      </div>
      <div class="col-6">
        <label class="form-label">Desc. socio</label>
        <input id="ventaDescSoc" type="number" min="0" class="form-control form-control-lg" value="0"/>
      </div>
      <div class="col-6">
        <label class="form-label">Descuadre</label>
        <input id="ventaDescuadre" type="number" min="0" class="form-control form-control-lg" value="0"/>
      </div>
      <div class="col-12 d-grid mt-2">
        <button id="btnAddVenta" class="btn btn-success btn-fat">Agregar venta</button>
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-sm align-middle" id="tblVentas">
        <thead><tr><th>Fecha</th><th>Hora</th><th>POS</th><th>SKU</th><th>Prod</th><th>Cant</th><th>Pago</th><th>Desc</th><th>Descuadre</th><th>Total</th><th>Notas</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- POS (Barra/Granizados) -->
  <section id="pos" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Barra / Granizados (Inventarios · Compras · Gastos)</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Inventario del día</h6>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">POS</label>
              <select id="invPOS" class="form-select">
                <option>Barra</option><option>Granizados</option>
              </select>
            </div>
            <div class="col-6 d-grid">
              <button id="btnInventarioInicial" class="btn btn-outline-dark mt-4">Cargar catálogo POS</button>
            </div>
            <div class="col-12">
              <label class="form-label">Contar stock inicial (editar cantidades)</label>
              <div id="invInicial" class="table-responsive"></div>
            </div>
            <div class="col-12 d-grid">
              <button id="btnGuardarInicial" class="btn btn-dark">Guardar inventario inicial</button>
            </div>
            <hr/>
            <div class="col-12">
              <label class="form-label">Contar stock final</label>
              <div id="invFinal" class="table-responsive"></div>
            </div>
            <div class="col-12 d-grid">
              <button id="btnGuardarFinal" class="btn btn-dark">Guardar inventario final</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Compras / Reposición</h6>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">SKU</label>
              <select id="compraSku" class="form-select"></select>
            </div>
            <div class="col-3">
              <label class="form-label">Cant.</label>
              <input id="compraCant" type="number" min="1" class="form-control" value="1"/>
            </div>
            <div class="col-3">
              <label class="form-label">PU</label>
              <input id="compraPU" type="number" min="0" class="form-control" value="0"/>
            </div>
            <div class="col-12">
              <label class="form-label">Factura (foto)</label>
              <input id="compraFactura" type="file" accept="image/*" class="form-control"/>
            </div>
            <div class="col-12">
              <label class="form-label">Notas</label>
              <input id="compraNotas" class="form-control"/>
            </div>
            <div class="col-12 d-grid">
              <button id="btnAddCompra" class="btn btn-primary">Agregar compra</button>
            </div>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm" id="tblCompras"><thead><tr><th>Fecha</th><th>SKU</th><th>Prod</th><th>Cant</th><th>PU</th><th>Total</th><th>Factura</th><th>Notas</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div class="tile mt-3">
          <h6>Gastos</h6>
          <div class="row g-2">
            <div class="col-4"><select id="gastoTipo" class="form-select"><option value="Gasto">Gasto</option><option value="Nomina">Nómina</option><option value="DescuentoSocio">DescuentoSocio</option></select></div>
            <div class="col-4"><input id="gastoConcepto" class="form-control" placeholder="Concepto"/></div>
            <div class="col-4"><input id="gastoValor" type="number" min="0" class="form-control" placeholder="Valor"/></div>
            <div class="col-6"><input id="gastoSocio" class="form-control" placeholder="Socio/Persona (atribución)"/></div>
            <div class="col-6"><input id="gastoNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddGasto" class="btn btn-warning">Agregar gasto</button></div>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm" id="tblGastos"><thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Valor</th><th>Atribuido</th><th>Notas</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SOCIOS -->
  <section id="socios" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Socios: KPIs, cierres y reparto</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-12 tile">
        <h6>Participación de socios</h6>
        <div id="sociosCfg" class="row g-2"></div>
        <div class="mt-2 d-flex gap-2">
          <input id="nuevoSocio" class="form-control" placeholder="Nombre socio"/>
          <input id="nuevoPct" type="number" min="0" max="100" class="form-control" placeholder="%"/>
          <button id="btnAddSocio" class="btn btn-dark">Agregar socio</button>
        </div>
        <div class="small text-muted mt-1">El reparto se calcula **después** de gastos (Gasto, Nómina, DescuentoSocio). Descuadres: se asignan como deuda a los encargados del POS.</div>
      </div>

      <div class="col-12 tile mt-3">
        <h6>Cierre diario</h6>
        <div class="d-flex gap-2">
          <input type="date" id="cierreFecha" class="form-control" style="max-width:200px"/>
          <button id="btnCierreDia" class="btn btn-outline-dark">Generar</button>
        </div>
        <div id="cierreDia" class="mt-3"></div>
      </div>

      <div class="col-12 tile mt-3">
        <h6>Cierre semanal + reparto por socio</h6>
        <div class="d-flex gap-2">
          <input type="date" id="semDesde" class="form-control" style="max-width:200px"/>
          <input type="date" id="semHasta" class="form-control" style="max-width:200px"/>
          <button id="btnCierreSem" class="btn btn-outline-dark">Generar</button>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-12 col-lg-6"><div id="cierreSemResumen"></div></div>
          <div class="col-12 col-lg-6"><div id="cierreReparto"></div></div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sticky-footer d-flex justify-content-between align-items-center">
  <div class="small text-muted">PWA lista para “Agregar a pantalla de inicio”. Datos locales. Para multi-sede: conectar BD.</div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-secondary" data-goto="home">Inicio</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
dayjs.extend(dayjs_plugin_customParseFormat); dayjs.locale('es');

const LS = 'bar_mvp_pwa_v1';
const state = loadState() || seed();

function seed(){
  return {
    socios: [
      { nombre: "Socio A", pct: 50 },
      { nombre: "Socio B", pct: 50 }
    ],
    encargados: { Barra: "Encargado Barra", Granizados: "Encargado Granizados" },
    inventario: catalogoBase(),
    ventas: [],
    compras: [],
    gastos: [],
  };
}

function catalogoBase(){
  // POS Barra: 10 alcoholes típicos en Medellín
  const barra = [
    { sku:"AGU-MED-375", nombre:"Aguardiente Antioqueño 375ml", precioUnit:45000 },
    { sku:"AGU-MED-750", nombre:"Aguardiente Antioqueño 750ml", precioUnit:85000 },
    { sku:"RON-MED-750", nombre:"Ron Medellín Añejo 750ml", precioUnit:95000 },
    { sku:"RON-3AN-750", nombre:"Ron Medellín 3 Años 750ml", precioUnit:90000 },
    { sku:"TEQ-JC-750", nombre:"Tequila José Cuervo 750ml", precioUnit:140000 },
    { sku:"WHS-OP-750", nombre:"Whisky Old Parr 12 750ml", precioUnit:220000 },
    { sku:"WHS-BC-750", nombre:"Whisky Buchanan's 12 750ml", precioUnit:230000 },
    { sku:"VDK-SM-750", nombre:"Vodka Smirnoff 750ml", precioUnit:90000 },
    { sku:"GIN-BF-750", nombre:"Ginebra Beefeater 750ml", precioUnit:120000 },
    { sku:"CERV-POK-330", nombre:"Cerveza Poker 330ml", precioUnit:8000 }
  ].map(p => ({ ...p, tipo:"producto", pos:"Barra", stockInicial:0, compras:0, vendidos:0, stockFinal:0, vasosPorUnidad:0 }));
  // POS Granizados: 3 (uno con promo 2x1 -> 2 vasos)
  const grz = [
    { sku:"GRZ-MAR", nombre:"Granizado Maracuyá", precioUnit:12000, vasosPorUnidad:1 },
    { sku:"GRZ-FRE", nombre:"Granizado Fresa", precioUnit:12000, vasosPorUnidad:1 },
    { sku:"GRZ-2X1", nombre:"Granizado Promo 2x1", precioUnit:20000, vasosPorUnidad:2 }
  ].map(p => ({ ...p, tipo:"producto", pos:"Granizados", stockInicial:0, compras:0, vendidos:0, stockFinal:0 }));
  // Insumo vasos 12oz (global)
  const vasos = [{ sku:"VASO-12", nombre:"Vaso plástico 12oz", precioUnit:400, tipo:"insumo", pos:"Barra", stockInicial:0, compras:0, vendidos:0, stockFinal:0, vasosPorUnidad:0 }];
  return [...barra, ...grz, ...vasos];
}

function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
function loadState(){ try { return JSON.parse(localStorage.getItem(LS)); } catch(e){ return null; } }
function money(n){ return (n||0).toLocaleString('es-CO',{style:'currency', currency:'COP', maximumFractionDigits:0}); }
function today(){ return dayjs().format('YYYY-MM-DD'); }
function now(){ return dayjs().format('HH:mm'); }
function el(id){ return document.getElementById(id); }

// ===== NAV =====
document.querySelectorAll('[data-goto]').forEach(btn => {
  btn.addEventListener('click', () => { goto(btn.dataset.goto); });
});
function goto(id){
  ['home','mesero','pos','socios'].forEach(sec => document.getElementById(sec).hidden = (sec!==id));
  renderAll();
}

// ===== HOME KPIs =====
function kpisHoy(){
  const d = today();
  const v = state.ventas.filter(x=>x.fecha===d);
  const g = state.gastos.filter(x=>x.fecha===d);

  let total=0, ef=0, tr=0, desc=0, descu=0;
  v.forEach(x=>{
    const it = state.inventario.find(i=>i.sku===x.sku) || {precioUnit:0};
    const neto = it.precioUnit*x.cantidad - (x.descuentoSocio||0) - (x.descuadre||0);
    total+=neto; if(x.metodoPago==='Efectivo') ef+=neto; else tr+=neto;
    desc+=x.descuentoSocio||0; descu+=x.descuadre||0;
  });

  let gto=0, nom=0, dss=0;
  g.forEach(y=>{
    if(y.tipo==='Gasto') gto+=y.valor;
    else if(y.tipo==='Nomina'||y.tipo==='Nómina') nom+=y.valor;
    else if(y.tipo==='DescuentoSocio') dss+=y.valor;
  });

  const util = total - (gto+nom+dss);

  el('kpiVentas').textContent = money(total);
  el('kpiEfec').textContent = money(ef);
  el('kpiTransf').textContent = money(tr);
  el('kpiUtil').textContent = money(util);
}

// ===== MESERO =====
function buildProductoSelectPOS(){
  const pos = el('ventaPOS').value;
  const opts = state.inventario.filter(i=>i.pos===pos && i.tipo==='producto')
    .map(i=>`<option value="${i.sku}">${i.nombre} (${i.sku})</option>`).join('');
  el('ventaSku').innerHTML = opts;
}
el('ventaPOS').addEventListener('change', buildProductoSelectPOS);

function addVenta(){
  const pos = el('ventaPOS').value;
  const sku = el('ventaSku').value;
  const cant = +el('ventaCant').value || 1;
  const pago = el('ventaPago').value;
  const notas = el('ventaNotas').value.trim();
  const descSoc = +el('ventaDescSoc').value || 0;
  const descuadre = +el('ventaDescuadre').value || 0;
  const fecha = today();
  const hora = now();
  const item = state.inventario.find(i=>i.sku===sku);
  if(!item) return alert('Producto no existe');
  if(item.stockFinal < cant) return alert('Stock insuficiente');

  // aplicar venta
  item.vendidos += cant; item.stockFinal -= cant;

  // vasos
  if(item.vasosPorUnidad && item.vasosPorUnidad>0){
    const vasos = state.inventario.find(i=>i.sku==='VASO-12');
    if(vasos){
      const usar = cant * item.vasosPorUnidad;
      vasos.vendidos += usar; vasos.stockFinal -= usar;
    }
  }

  state.ventas.push({ id: Date.now(), fecha, hora, pos, sku, cantidad:cant, metodoPago:pago, descuentoSocio:descSoc, descuadre, notas });
  saveState(); renderVentas(); kpisHoy();
  el('ventaCant').value = 1; el('ventaNotas').value=''; el('ventaDescSoc').value=0; el('ventaDescuadre').value=0;
}
el('btnAddVenta').addEventListener('click', addVenta);

function renderVentas(){
  const tb = el('tblVentas').querySelector('tbody'); tb.innerHTML='';
  state.ventas.slice().reverse().forEach((v, idxRev)=>{
    const idx = state.ventas.length-1-idxRev;
    const it = state.inventario.find(i=>i.sku===v.sku) || {precioUnit:0, nombre:''};
    const total = it.precioUnit*v.cantidad - (v.descuentoSocio||0) - (v.descuadre||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${v.fecha}</td><td>${v.hora}</td><td><span class="pos-pill pos-${v.pos}">${v.pos}</span></td><td>${v.sku}</td><td>${it.nombre}</td><td>${v.cantidad}</td><td>${v.metodoPago}</td><td>${money(v.descuentoSocio||0)}</td><td>${money(v.descuadre||0)}</td><td>${money(total)}</td><td>${v.notas||''}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-idx="${idx}">Editar</button><button class="btn btn-sm btn-outline-danger" data-action="del" data-idx="${idx}">X</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', ventaRowAction));
}
function ventaRowAction(e){
  const idx = +e.target.dataset.idx;
  const action = e.target.dataset.action;
  const v = state.ventas[idx];
  const it = state.inventario.find(i=>i.sku===v.sku);
  if(action==='del'){
    if(confirm('¿Borrar venta?')){
      if(it){ it.vendidos -= v.cantidad; it.stockFinal += v.cantidad; }
      if(it?.vasosPorUnidad>0){
        const vasos = state.inventario.find(i=>i.sku==='VASO-12');
        if(vasos){ const usar = v.cantidad*it.vasosPorUnidad; vasos.vendidos -= usar; vasos.stockFinal += usar; }
      }
      state.ventas.splice(idx,1); saveState(); renderVentas(); kpisHoy();
    }
  } else if(action==='edit'){
    // precargar
    goto('mesero');
    el('ventaPOS').value = v.pos; buildProductoSelectPOS();
    el('ventaSku').value = v.sku;
    el('ventaCant').value = v.cantidad;
    el('ventaPago').value = v.metodoPago;
    el('ventaNotas').value = v.notas||'';
    el('ventaDescSoc').value = v.descuentoSocio||0;
    el('ventaDescuadre').value = v.descuadre||0;
    // al guardar, reemplazar: borramos y pedimos que reingrese (simple y seguro)
    if(confirm('Para editar, se eliminará la venta actual y vuelves a agregarla con los cambios. ¿Continuar?')){
      ventaRowAction({target:{dataset:{idx, action:'del'}}});
    }
  }
}

// ===== POS Inventarios/Compras/Gastos =====
function rebuildCompraSelect(){
  const opts = state.inventario.map(i=>`<option value="${i.sku}">${i.nombre} (${i.sku})</option>`).join('');
  el('compraSku').innerHTML = opts;
}

function tableInventario(pos, tipo){
  const items = state.inventario.filter(i=>i.pos===pos && i.tipo==='producto');
  const rows = items.map(i=>`
    <tr>
      <td>${i.sku}</td><td>${i.nombre}</td>
      <td style="width:110px"><input class="form-control form-control-sm" type="number" value="${tipo==='inicial'? i.stockInicial: i.stockFinal}" data-sku="${i.sku}" data-tipo="${tipo}"/></td>
    </tr>
  `).join('');
  return `<table class="table table-sm"><thead><tr><th>SKU</th><th>Producto</th><th>Cantidad</th></tr></thead><tbody>${rows}</tbody></table>`;
}

el('btnInventarioInicial').addEventListener('click', ()=>{
  const pos = el('invPOS').value;
  el('invInicial').innerHTML = tableInventario(pos,'inicial');
  el('invFinal').innerHTML = tableInventario(pos,'final');
});

el('btnGuardarInicial').addEventListener('click', ()=>{
  document.querySelectorAll('#invInicial input[data-tipo="inicial"]').forEach(inp=>{
    const i = state.inventario.find(x=>x.sku===inp.dataset.sku);
    const v = +inp.value||0;
    i.stockInicial = v;
    // resetea final si no se ha contado aún
    if(i.stockFinal===0) i.stockFinal = v;
  });
  saveState(); alert('Inventario inicial guardado');
});

el('btnGuardarFinal').addEventListener('click', ()=>{
  document.querySelectorAll('#invFinal input[data-tipo="final"]').forEach(inp=>{
    const i = state.inventario.find(x=>x.sku===inp.dataset.sku);
    const v = +inp.value||0;
    i.stockFinal = v;
  });
  saveState(); alert('Inventario final guardado');
});

// Compras
el('btnAddCompra').addEventListener('click', ()=>{
  const sku = el('compraSku').value;
  const cant = +el('compraCant').value||0;
  const pu = +el('compraPU').value||0;
  const notas = el('compraNotas').value.trim();
  const file = el('compraFactura').files[0];

  const it = state.inventario.find(i=>i.sku===sku);
  if(!it) return alert('SKU no existe');
  it.compras += cant; it.stockFinal += cant;

  const add = (factura)=>{
    state.compras.push({ id: Date.now(), fecha: today(), sku, cant, pu, notas, factura });
    saveState(); renderCompras();
    el('compraCant').value=1; el('compraPU').value=0; el('compraNotas').value=''; el('compraFactura').value='';
  }

  if(file){
    const reader = new FileReader();
    reader.onload = ()=> add(reader.result);
    reader.readAsDataURL(file);
  } else add(null);
});

function renderCompras(){
  const tb = el('tblCompras').querySelector('tbody'); tb.innerHTML='';
  state.compras.slice().reverse().forEach((c, idxRev)=>{
    const idx = state.compras.length-1-idxRev;
    const it = state.inventario.find(i=>i.sku===c.sku) || {nombre:''};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.fecha}</td><td>${c.sku}</td><td>${it.nombre}</td><td>${c.cant}</td><td>${money(c.pu)}</td><td>${money(c.cant*c.pu)}</td><td>${c.factura?'<span class="badge bg-secondary">Sí</span>':'—'}</td><td>${c.notas||''}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" data-action="del" data-idx="${idx}">X</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
    const idx = +e.target.dataset.idx;
    if(confirm('¿Eliminar compra?')){
      const c = state.compras[idx];
      const it = state.inventario.find(i=>i.sku===c.sku);
      if(it){ it.compras -= c.cant; it.stockFinal -= c.cant; }
      state.compras.splice(idx,1); saveState(); renderCompras();
    }
  }));
}

// Gastos
el('btnAddGasto').addEventListener('click', ()=>{
  const tipo = el('gastoTipo').value;
  const concepto = el('gastoConcepto').value.trim();
  const valor = +el('gastoValor').value||0;
  const socio = el('gastoSocio').value.trim();
  const notas = el('gastoNotas').value.trim();
  state.gastos.push({ id: Date.now(), fecha: today(), tipo, concepto, valor, socio, notas });
  saveState(); renderGastos();
  el('gastoConcepto').value=''; el('gastoValor').value=0; el('gastoSocio').value=''; el('gastoNotas').value='';
});

function renderGastos(){
  const tb = el('tblGastos').querySelector('tbody'); tb.innerHTML='';
  state.gastos.slice().reverse().forEach((g, idxRev)=>{
    const idx = state.gastos.length-1-idxRev;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${g.fecha}</td><td>${g.tipo}</td><td>${g.concepto}</td><td>${money(g.valor)}</td><td>${g.socio||'—'}</td><td>${g.notas||''}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-idx="${idx}">Editar</button><button class="btn btn-sm btn-outline-danger" data-action="del" data-idx="${idx}">X</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
    const idx = +e.target.dataset.idx;
    const action = e.target.dataset.action;
    if(action==='del'){
      if(confirm('¿Eliminar gasto?')){ state.gastos.splice(idx,1); saveState(); renderGastos(); }
    } else if(action==='edit'){
      const g = state.gastos[idx];
      el('gastoTipo').value = g.tipo; el('gastoConcepto').value=g.concepto; el('gastoValor').value=g.valor; el('gastoSocio').value=g.socio||''; el('gastoNotas').value=g.notas||'';
      if(confirm('Para editar, se eliminará y la vuelves a ingresar con cambios. ¿Continuar?')){
        state.gastos.splice(idx,1); saveState(); renderGastos();
      }
    }
  }));
}

// ===== SOCIOS Config & Cierres =====
function renderSociosCfg(){
  const cont = el('sociosCfg'); cont.innerHTML='';
  state.socios.forEach((s, i)=>{
    const div = document.createElement('div');
    div.className = 'col-12 col-md-6';
    div.innerHTML = `<div class="d-flex gap-2 align-items-center border rounded p-2"><input class="form-control" value="${s.nombre}" data-i="${i}" data-f="nombre"/><input type="number" class="form-control" value="${s.pct}" data-i="${i}" data-f="pct"/><span>%</span><button class="btn btn-sm btn-outline-danger" data-del="${i}">X</button></div>`;
    cont.appendChild(div);
  });
  cont.querySelectorAll('input').forEach(inp=>inp.addEventListener('change', (e)=>{
    const i = +e.target.dataset.i; const f = e.target.dataset.f;
    state.socios[i][f] = f==='pct' ? (+e.target.value||0) : e.target.value;
    saveState();
  }));
  cont.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click', (e)=>{
    const i = +e.target.dataset.del;
    state.socios.splice(i,1); saveState(); renderSociosCfg();
  }));
}
el('btnAddSocio').addEventListener('click', ()=>{
  const n = el('nuevoSocio').value.trim(); const p = +el('nuevoPct').value||0;
  if(!n) return; state.socios.push({nombre:n, pct:p}); el('nuevoSocio').value=''; el('nuevoPct').value=''; saveState(); renderSociosCfg();
});

function cierreDiarioHTML(fecha){
  const v = state.ventas.filter(x=>x.fecha===fecha);
  const g = state.gastos.filter(x=>x.fecha===fecha);
  const c = state.compras.filter(x=>x.fecha===fecha);

  const porPOS = (pos) => v.filter(x=>x.pos===pos).reduce((acc,cur)=>{
    const it = state.inventario.find(i=>i.sku===cur.sku) || {precioUnit:0};
    const neto = it.precioUnit*cur.cantidad - (cur.descuentoSocio||0) - (cur.descuadre||0);
    acc.total+=neto; if(cur.metodoPago==='Efectivo') acc.ef+=neto; else acc.tr+=neto;
    acc.desc += cur.descuentoSocio||0; acc.desq += cur.descuadre||0;
    return acc;
  }, {total:0, ef:0, tr:0, desc:0, desq:0});

  const barra = porPOS('Barra'); const grz = porPOS('Granizados');

  let gto=0, nom=0, dss=0;
  const porSocio = {};
  g.forEach(x=>{
    if(x.tipo==='Gasto') gto+=x.valor;
    else if(x.tipo==='Nomina'||x.tipo==='Nómina') nom+=x.valor;
    else if(x.tipo==='DescuentoSocio') dss+=x.valor;
    const key = x.socio||'—';
    porSocio[key] = (porSocio[key]||0) + x.valor;
  });

  const descuadreBarra = barra.desq;
  const descuadreGrz = grz.desq;

  const html = `
  <div class="row g-2">
    <div class="col-12 col-lg-6"><div class="tile">
      <h6>Ventas Barra</h6>
      <div>Total: <b>${money(barra.total)}</b></div>
      <div>Efectivo: ${money(barra.ef)} · Transf: ${money(barra.tr)}</div>
      <div>Desc (ventas): ${money(barra.desc)} · Descuadre: ${money(barra.desq)}</div>
    </div></div>
    <div class="col-12 col-lg-6"><div class="tile">
      <h6>Ventas Granizados</h6>
      <div>Total: <b>${money(grz.total)}</b></div>
      <div>Efectivo: ${money(grz.ef)} · Transf: ${money(grz.tr)}</div>
      <div>Desc (ventas): ${money(grz.desc)} · Descuadre: ${money(grz.desq)}</div>
    </div></div>
  </div>
  <div class="tile mt-2">
    <h6>Gastos del día</h6>
    <div>Gastos: <b>${money(gto)}</b> · Nómina: <b>${money(nom)}</b> · Desc. Socios: <b>${money(dss)}</b></div>
  </div>
  <div class="tile mt-2">
    <h6>Compras del día</h6>
    <div>${money(c.reduce((a,b)=>a+b.cant*b.pu,0))}</div>
  </div>
  <div class="tile mt-2">
    <h6>Deudas por descuadre (empleados)</h6>
    <div>Barra (${state.encargados.Barra}): <b>${money(descuadreBarra)}</b></div>
    <div>Granizados (${state.encargados.Granizados}): <b>${money(descuadreGrz)}</b></div>
  </div>`;
  return html;
}

el('btnCierreDia').addEventListener('click', ()=>{
  const f = el('cierreFecha').value || today();
  el('cierreDia').innerHTML = cierreDiarioHTML(f);
});

function cierreSemanal(desde,hasta){
  const inR = d => dayjs(d).isAfter(dayjs(desde).subtract(1,'day')) && dayjs(d).isBefore(dayjs(hasta).add(1,'day'));
  const v = state.ventas.filter(x=>inR(x.fecha));
  const g = state.gastos.filter(x=>inR(x.fecha));

  let totalVentas=0, descV=0, desqV=0, ef=0, tr=0;
  v.forEach(x=>{
    const it = state.inventario.find(i=>i.sku===x.sku) || {precioUnit:0};
    const neto = it.precioUnit*x.cantidad - (x.descuentoSocio||0) - (x.descuadre||0);
    totalVentas += neto;
    if(x.metodoPago==='Efectivo') ef+=neto; else tr+=neto;
    descV += x.descuentoSocio||0;
    desqV += x.descuadre||0;
  });

  let gto=0, nom=0, dss=0;
  const gastosPorSocio = {};
  g.forEach(y=>{
    if(y.tipo==='Gasto') gto+=y.valor;
    else if(y.tipo==='Nomina'||y.tipo==='Nómina') nom+=y.valor;
    else if(y.tipo==='DescuentoSocio') dss+=y.valor;
    if(y.socio){ gastosPorSocio[y.socio] = (gastosPorSocio[y.socio]||0) + y.valor; }
  });

  // deudas por descuadre a encargados
  const deudas = { };
  const barraDes = state.ventas.filter(x=>inR(x.fecha) && x.pos==='Barra').reduce((a,b)=>a+(b.descuadre||0),0);
  const grzDes = state.ventas.filter(x=>inR(x.fecha) && x.pos==='Granizados').reduce((a,b)=>a+(b.descuadre||0),0);
  deudas[state.encargados.Barra] = barraDes;
  deudas[state.encargados.Granizados] = grzDes;

  const utilidadNeta = totalVentas - (gto+nom+dss);

  // reparto por % de socios, luego ajustes por gastos/desc propios
  const reparto = state.socios.map(s => {
    const base = utilidadNeta * (s.pct/100);
    const atrib = gastosPorSocio[s.nombre] || 0; // incluye DescuentoSocio si se atribuyó al socio
    const final = base - atrib;
    return { socio: s.nombre, pct: s.pct, base: Math.round(base), ajustes: Math.round(-atrib), final: Math.round(final) };
  });

  // Render
  el('cierreSemResumen').innerHTML = `
    <div class="tile">
      <div><b>${desde}</b> a <b>${hasta}</b></div>
      <div class="mt-2">Ventas: <b>${money(totalVentas)}</b> · Efectivo: ${money(ef)} · Transf: ${money(tr)}</div>
      <div>Desc (ventas): ${money(descV)} · Descuadres: ${money(desqV)}</div>
      <div>Gastos: ${money(gto)} · Nómina: ${money(nom)} · Desc. Socios: ${money(dss)}</div>
      <div class="mt-2">Utilidad neta: <b>${money(utilidadNeta)}</b></div>
      <div class="mt-2"><b>Deudas (empleados)</b>: ${state.encargados.Barra}: ${money(barraDes)} · ${state.encargados.Granizados}: ${money(grzDes)}</div>
    </div>
  `;

  el('cierreReparto').innerHTML = `
    <div class="tile">
      <h6>Reparto por socio (después de gastos)</h6>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Socio</th><th>%</th><th>Base</th><th>Ajustes (gastos y desc propios)</th><th>Total a pagar</th></tr></thead>
          <tbody>${reparto.map(r=>`<tr><td>${r.socio}</td><td>${r.pct}%</td><td>${money(r.base)}</td><td>${money(r.ajustes)}</td><td><b>${money(r.final)}</b></td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>
  `;
}
el('btnCierreSem').addEventListener('click', ()=>{
  const d = el('semDesde').value, h = el('semHasta').value;
  if(!d || !h) return alert('Selecciona fechas');
  cierreSemanal(d,h);
});

// ===== Export =====
document.getElementById('btnExportXLSX').addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  const ventas = state.ventas.map(v=>{
    const it = state.inventario.find(i=>i.sku===v.sku) || {precioUnit:0, nombre:''};
    const total = it.precioUnit*v.cantidad - (v.descuentoSocio||0) - (v.descuadre||0);
    return {Fecha:v.fecha, Hora:v.hora, POS:v.pos, SKU:v.sku, Producto:it.nombre, Cantidad:v.cantidad, Metodo:v.metodoPago, DescSocio:v.descuentoSocio||0, Descuadre:v.descuadre||0, Total:total, Notas:v.notas||''};
  });
  const compras = state.compras.map(c=>{
    const it = state.inventario.find(i=>i.sku===c.sku) || {nombre:''};
    return {Fecha:c.fecha, SKU:c.sku, Producto:it.nombre, Cantidad:c.cant, PU:c.pu, Total:c.cant*c.pu, Notas:c.notas||''};
  });
  const gastos = state.gastos.map(g=>({Fecha:g.fecha, Tipo:g.tipo, Concepto:g.concepto, Valor:g.valor, Socio:g.socio||'', Notas:g.notas||''}));

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ventas), 'Ventas');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(compras), 'Compras');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gastos), 'Gastos');
  XLSX.writeFile(wb, `cierre_${today()}.xlsx`);
});

document.getElementById('btnExportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  let y = 36; const x = 36;
  doc.setFontSize(16); doc.text(`Resumen ${today()}`, x, y); y+=20;
  // KPIs rápidos
  const d = today();
  const v = state.ventas.filter(x=>x.fecha===d);
  let total=0, ef=0, tr=0;
  v.forEach(o=>{ const it = state.inventario.find(i=>i.sku===o.sku)||{precioUnit:0}; const neto = it.precioUnit*o.cantidad - (o.descuentoSocio||0) - (o.descuadre||0); total+=neto; if(o.metodoPago==='Efectivo') ef+=neto; else tr+=neto; });
  doc.setFontSize(11);
  doc.text(`Ventas: ${money(total)}  (Efectivo ${money(ef)} · Transf ${money(tr)})`, x, y); y+=16;
  doc.save(`cierre_${today()}.pdf`);
});

// ===== Reset =====
document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('¿Resetear datos?')){
    localStorage.removeItem(LS);
    Object.assign(state, seed());
    saveState(); renderAll();
  }
});

// ===== Render All =====
function renderAll(){
  // home
  kpisHoy();
  // mesero
  buildProductoSelectPOS();
  renderVentas();
  // pos
  rebuildCompraSelect();
  renderCompras();
  renderGastos();
  // socios
  renderSociosCfg();
}

renderAll();
goto('home');

// ===== PWA SW =====
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>
</body>
</html>
