<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Bar Control • PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    :root { --pad: 14px; }
    body { background:#f7f7f8; }
    .app { max-width: 1080px; margin: 0 auto; padding: var(--pad); }
    .tile { padding: 16px; border-radius: 16px; border:1px solid #eee; background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .btn-fat { padding: 14px 16px; font-size: 18px; border-radius: 14px; }
    .mini { font-size: 12px; color:#666; }
    .kpi { border: 1px dashed #ddd; border-radius: 12px; padding: 12px; background:#fafafa; }
    .sticky-footer { position: sticky; bottom: 0; left: 0; right: 0; padding: 8px 0; background:linear-gradient(to top, #fff, #fff0 60%); }
    .badge-dark { background:#111; }
    .table input { width: 100%; }
    .pill { background:#fef7cd; border:1px solid #eee; border-radius: 9999px; padding:4px 10px; font-size:12px; }
    .pill-green { background:#e9f9ef; }
    .pill-red { background:#fde2e0; }
    .tag { display:inline-block; background:#f0f0f0; border-radius:8px; padding:2px 6px; margin-right:4px; font-size:12px; }
  </style>
</head>
<body>
<div class="app">

  <header class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="m-0">Control Bar / Discoteca · PWA</h4>
    <div class="d-flex gap-2">
      <button id="btnExportXLSX" class="btn btn-sm btn-outline-primary">Excel</button>
      <button id="btnExportPDF" class="btn btn-sm btn-outline-danger">PDF</button>
      <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset</button>
    </div>
  </header>

  <!-- HOME ROLES -->
  <section id="home" class="tile">
    <div class="mb-3">
      <label class="form-label">Soy:</label>
      <div class="row g-2">
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="mesero">Mesero (Ventas Rápidas)</button></div>
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="pos">Barra / Granizados (Inventario · Compras · Gastos)</button></div>
        <div class="col-12 col-md-4"><button class="w-100 btn btn-dark btn-fat" data-goto="socios">Socios (KPIs · Cierres · Distribución)</button></div>
      </div>
    </div>

    <div class="row g-2">
      <div class="col-12 col-md-3"><div class="kpi"><div class="mini">Ventas hoy</div><div id="kpiVentasHoy" class="fs-5">$ 0</div></div></div>
      <div class="col-12 col-md-3"><div class="kpi"><div class="mini">Efectivo</div><div id="kpiEfectivoHoy" class="fs-5">$ 0</div></div></div>
      <div class="col-12 col-md-3"><div class="kpi"><div class="mini">Transf.</div><div id="kpiTransfHoy" class="fs-5">$ 0</div></div></div>
      <div class="col-12 col-md-3"><div class="kpi"><div class="mini">Utilidad hoy</div><div id="kpiUtilidadHoy" class="fs-5">$ 0</div></div></div>
    </div>
  </section>

  <!-- (… TU HTML original de Mesero, POS, Socios, tablas, formularios, etc. …)
       No toqué tu estructura de UI. -->

  <!-- ==== Librerías ==== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ====== Supabase + config (NUEVO) ====== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    const supabase = window.supabase.createClient(
      window.ENV.SUPABASE_URL,
      window.ENV.SUPABASE_ANON_KEY
    );
  </script>

  <!-- ====== App Code ====== -->
  <script>
  dayjs.extend(dayjs_plugin_customParseFormat); dayjs.locale('es');

  /* ======= Helpers de formato / util ======= */
  const money = v => '$ ' + (v||0).toLocaleString('es-CO');
  const today = () => dayjs().format('YYYY-MM-DD');
  const now   = () => dayjs().format('HH:mm');
  const el    = id => document.getElementById(id);

  /* ======= Persistencia Supabase (MVP) ======= */
  async function dbUpsertInventarioDia(row){
    try { return await supabase.from('mvp_inventario_dia').upsert(row, { onConflict:'fecha,pos,sku' }); }
    catch(e){ console.error('dbUpsertInventarioDia', e); }
  }
  async function dbInsertVenta(v){
    try { return await supabase.from('mvp_venta').insert({
      fecha:v.fecha, hora:v.hora, pos:v.pos, sku:v.sku, cantidad:v.cantidad,
      metodo_pago:v.metodoPago, descuento_socio:v.descuentoSocio||0,
      descuadre:v.descuadre||0, notas:v.notas||null
    }); } catch(e){ console.error('dbInsertVenta', e); }
  }
  async function dbInsertCompra(c){
    try { return await supabase.from('mvp_compra').insert({
      fecha:c.fecha, sku:c.sku, cant:c.cant, pu:c.pu, notas:c.notas||null, factura_url:c.factura||null
    }); } catch(e){ console.error('dbInsertCompra', e); }
  }
  async function dbInsertGasto(g){
    try { return await supabase.from('mvp_gasto').insert({
      fecha:g.fecha, tipo:g.tipo, concepto:g.concepto, valor:g.valor, socio:g.socio||null, notas:g.notas||null
    }); } catch(e){ console.error('dbInsertGasto', e); }
  }
  async function dbSyncSocios(){
    try {
      await supabase.from('mvp_socio').delete().neq('id','00000000-0000-0000-0000-000000000000');
      if(state.socios.length) await supabase.from('mvp_socio').insert(state.socios);
    } catch(e){ console.error('dbSyncSocios', e); }
  }
  async function dbSyncEncargados(){
    try {
      await supabase.from('mvp_encargado').upsert({pos:'Barra', nombre:state.encargados.Barra}, {onConflict:'pos'});
      await supabase.from('mvp_encargado').upsert({pos:'Granizados', nombre:state.encargados.Granizados}, {onConflict:'pos'});
    } catch(e){ console.error('dbSyncEncargados', e); }
  }
  async function dbHydrateToday(){
    try {
      const { data:inv, error } = await supabase.from('mvp_inventario_dia').select('*').eq('fecha', today());
      if(error) console.error(error);
      if(inv && inv.length){
        for(const r of inv){
          const it = state.inventario.find(x=>x.sku===r.sku && x.pos===r.pos);
          if(it){
            it.stockInicial = r.stock_inicial;
            it.compras     = r.compras;
            it.stockFinal  = r.stock_final;
            it.precioUnit  = +r.precio_unit || it.precioUnit;
            it.vasosPorUnidad = r.vasos_por_unidad || it.vasosPorUnidad;
          }
        }
      }
    } catch(e){ console.error('dbHydrateToday', e); }
  }

  /* ======= Estado (localStorage) ======= */
  const LS = 'bar_mvp_pwa_v1';
  const state = loadState() || seed();

  function seed(){
    return {
      socios: [
        { nombre: "Socio A", pct: 50 },
        { nombre: "Socio B", pct: 50 }
      ],
      encargados: { Barra: "Encargado Barra", Granizados: "Encargado Granizados" },
      inventario: catalogoBase(),
      ventas: [],
      compras: [],
      gastos: []
    };
  }
  function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
  function loadState(){
    try{ const s = localStorage.getItem(LS); return s? JSON.parse(s): null; } catch(e){ return null; }
  }

  /* ======= (… AQUÍ SIGUE TODO TU CÓDIGO ORIGINAL …) =======
     NO te copio todo para ahorrar espacio en esta respuesta, pero
     LAS ÚNICAS MODIFICACIONES QUE HICE DENTRO DE TU LÓGICA SON ESTAS:
     - En addVenta(): después del push → dbInsertVenta({...})
     - En btnAddCompra: después del push → dbInsertCompra({...})
     - En btnAddGasto:  después del push → dbInsertGasto({...})
     - En Guardar Inicial/Final: dentro del forEach → dbUpsertInventarioDia({...})
     - Al final: reemplacé `renderAll(); goto('home');` por un IIFE que primero hidrata desde DB.
  */

  /* ======= VENTAS (fragmento modificado) ======= */
  function addVenta(){
    const pos = el('ventaPOS').value;
    const sku = el('ventaSku').value;
    const cant = +el('ventaCant').value || 1;
    const pago = el('ventaPago').value;
    const notas = el('ventaNotas').value.trim();
    const descSoc = +el('ventaDescSoc').value || 0;
    const descuadre = +el('ventaDescuadre').value || 0;
    const fecha = today();
    const hora = now();
    const item = state.inventario.find(i=>i.sku===sku);
    if(!item) return alert('Producto no existe');
    if(item.stockFinal < cant) return alert('Stock insuficiente');

    // aplicar venta
    item.vendidos += cant; item.stockFinal -= cant;

    // vasos
    if(item.vasosPorUnidad && item.vasosPorUnidad>0){
      const vasos = state.inventario.find(i=>i.sku==='VASO-12');
      if(vasos){
        const usar = cant * item.vasosPorUnidad;
        vasos.vendidos += usar; vasos.stockFinal -= usar;
      }
    }

    state.ventas.push({ id: Date.now(), fecha, hora, pos, sku, cantidad:cant, metodoPago:pago, descuentoSocio:descSoc, descuadre, notas });
    // NUEVO: persistir
    dbInsertVenta({fecha, hora, pos, sku, cantidad:cant, metodoPago:pago, descuentoSocio:descSoc, descuadre, notas});

    saveState(); renderVentas(); kpisHoy();
    el('ventaCant').value = 1; el('ventaNotas').value=''; el('ventaDescSoc').value=0; el('ventaDescuadre').value=0;
  }
  el('btnAddVenta').addEventListener('click', addVenta);

  /* ======= GUARDAR INVENTARIO INICIAL (fragmento modificado) ======= */
  el('btnGuardarInicial').addEventListener('click', ()=>{
    document.querySelectorAll('#invInicial input[data-tipo="inicial"]').forEach(inp=>{
      const i = state.inventario.find(x=>x.sku===inp.dataset.sku);
      const v = +inp.value||0;
      i.stockInicial = v;
      if(i.stockFinal===0) i.stockFinal = v;
      // NUEVO: persistir
      dbUpsertInventarioDia({
        fecha: today(), pos: i.pos, sku: i.sku, nombre: i.nombre,
        precio_unit: i.precioUnit||0, vasos_por_unidad: i.vasosPorUnidad||0,
        stock_inicial: i.stockInicial||0, compras: i.compras||0, stock_final: i.stockFinal||0
      });
    });
    saveState(); alert('Inventario inicial guardado');
  });

  /* ======= GUARDAR INVENTARIO FINAL (fragmento modificado) ======= */
  el('btnGuardarFinal').addEventListener('click', ()=>{
    document.querySelectorAll('#invFinal input[data-tipo="final"]').forEach(inp=>{
      const i = state.inventario.find(x=>x.sku===inp.dataset.sku);
      const v = +inp.value||0;
      i.stockFinal = v;
      // NUEVO: persistir
      dbUpsertInventarioDia({
        fecha: today(), pos: i.pos, sku: i.sku, nombre: i.nombre,
        precio_unit: i.precioUnit||0, vasos_por_unidad: i.vasosPorUnidad||0,
        stock_inicial: i.stockInicial||0, compras: i.compras||0, stock_final: i.stockFinal||0
      });
    });
    saveState(); alert('Inventario final guardado');
  });

  /* ======= COMPRAS (fragmento modificado) ======= */
  el('btnAddCompra').addEventListener('click', ()=>{
    const sku = el('compraSku').value;
    const cant = +el('compraCant').value||0;
    const pu = +el('compraPU').value||0;
    const notas = el('compraNotas').value.trim();
    const file = el('compraFactura').files[0];

    const it = state.inventario.find(i=>i.sku===sku);
    if(!it) return alert('SKU no existe');
    it.compras += cant; it.stockFinal += cant;

    const add = (factura)=>{
      state.compras.push({ id: Date.now(), fecha: today(), sku, cant, pu, notas, factura });
      // NUEVO: persistir
      dbInsertCompra({ fecha: today(), sku, cant, pu, notas, factura });
      saveState(); renderCompras();
      el('compraCant').value=1; el('compraPU').value=0; el('compraNotas').value=''; el('compraFactura').value='';
    }

    if(file){
      const reader = new FileReader();
      reader.onload = ()=> add(reader.result);
      reader.readAsDataURL(file);
    } else add(null);
  });

  /* ======= GASTOS (fragmento modificado) ======= */
  el('btnAddGasto').addEventListener('click', ()=>{
    const tipo = el('gastoTipo').value;
    const concepto = el('gastoConcepto').value.trim();
    const valor = +el('gastoValor').value||0;
    const socio = el('gastoSocio').value.trim();
    const notas = el('gastoNotas').value.trim();
    state.gastos.push({ id: Date.now(), fecha: today(), tipo, concepto, valor, socio, notas });
    // NUEVO: persistir
    dbInsertGasto({ fecha: today(), tipo, concepto, valor, socio, notas });
    saveState(); renderGastos();
    el('gastoConcepto').value=''; el('gastoValor').value=0; el('gastoSocio').value=''; el('gastoNotas').value='';
  });

  /* ======= Render y arranque ======= */
  function renderAll(){
    // kpis, tablas, etc… (tus funciones originales)
    kpisHoy();
    buildProductoSelectPOS();
    renderVentas();
    rebuildCompraSelect();
    renderCompras();
    renderGastos();
    renderSociosCfg();
  }

  // NUEVO: primero hidratar inventario del día desde Supabase
  (async function(){ await dbHydrateToday(); renderAll(); goto('home'); })();

  // PWA SW
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('service-worker.js');
    });
  }
  </script>
</div>
</body>
</html>
